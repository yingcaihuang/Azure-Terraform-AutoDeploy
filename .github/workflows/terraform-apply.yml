name: Terraform Apply

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
      approval_required:
        description: 'Require manual approval'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

env:
  TERRAFORM_VERSION: 1.6.0
  TFDEBUG: false

jobs:
  terraform-apply:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/deployments
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Verify Azure Credentials
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            echo "✅ Azure Login Successful"
            az account show --query '{"subscriptionId": id, "subscriptionName": name}' -o table

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        id: init
        run: terraform init -upgrade

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Determine Environment
        id: env
        run: |
          echo "env_file=env/${{ github.event.inputs.environment }}.tfvars" >> $GITHUB_OUTPUT
          echo "env_name=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file="${{ steps.env.outputs.env_file }}" \
            -no-color \
            -out=tfplan
        env:
          TF_VAR_tencent_secret_id: ${{ secrets.TENCENT_SECRET_ID }}
          TF_VAR_tencent_secret_key: ${{ secrets.TENCENT_SECRET_KEY }}

      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -auto-approve tfplan
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          TF_VAR_tencent_secret_id: ${{ secrets.TENCENT_SECRET_ID }}
          TF_VAR_tencent_secret_key: ${{ secrets.TENCENT_SECRET_KEY }}

      - name: Get Terraform Outputs
        id: outputs
        run: |
          terraform output -json > outputs.json
          cat outputs.json

      - name: Create Deployment Summary
        run: |
          echo "## Terraform Apply - ${{ steps.env.outputs.env_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Deployment Successful**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Outputs:" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat outputs.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Slack Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Terraform Apply: ${{ steps.env.outputs.env_name }} - ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
