name: Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - dev
          - prod
      confirmation:
        description: 'Type "destroy" to confirm'
        required: true

permissions:
  contents: read
  deployments: write

env:
  TERRAFORM_VERSION: 1.6.0

jobs:
  terraform-destroy:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirmation == 'destroy'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Verify Azure Credentials
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            echo "✅ Azure Login Successful"
            az account show --query '{"subscriptionId": id, "subscriptionName": name}' -o table

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        id: init
        run: terraform init -upgrade

      - name: Terraform Destroy
        id: destroy
        run: |
          terraform destroy \
            -var-file="env/${{ github.event.inputs.environment }}.tfvars" \
            -auto-approve \
            -no-color
        env:
          TF_VAR_tencent_secret_id: ${{ secrets.TENCENT_SECRET_ID }}
          TF_VAR_tencent_secret_key: ${{ secrets.TENCENT_SECRET_KEY }}

      - name: Create Destroy Summary
        run: |
          echo "## Terraform Destroy - ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Resources Destroyed Successfully**" >> $GITHUB_STEP_SUMMARY

      - name: Slack Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Terraform Destroy: ${{ github.event.inputs.environment }} - ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
